<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; media-src 'self' blob:; img-src 'self' data:;">
  <title>Screen Recorder</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', -apple-system, sans-serif;
      background: #18181b;
      min-height: 100vh;
      color: #fafafa;
    }

    .app {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* Header */
    .header {
      padding: 16px 20px;
      border-bottom: 1px solid #27272a;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo {
      width: 24px;
      height: 24px;
      background: #dc2626;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo svg {
      width: 12px;
      height: 12px;
      fill: #fff;
    }

    .header h1 {
      font-size: 16px;
      font-weight: 600;
      color: #fafafa;
      flex: 1;
    }

    .github-link {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #71717a;
      transition: color 0.15s ease;
      cursor: pointer;
    }

    .github-link:hover {
      color: #fafafa;
    }

    .github-link svg {
      width: 20px;
      height: 20px;
    }

    /* Main content */
    .main {
      flex: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* Preview */
    .preview-container {
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }

    .preview-video {
      width: 100%;
      height: 180px;
      object-fit: contain;
      display: block;
    }

    .preview-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #09090b;
      pointer-events: none;
    }

    .preview-overlay span {
      color: #52525b;
      font-size: 13px;
    }

    .preview-overlay.hidden {
      display: none;
    }

    /* Timer */
    .timer-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      background: #27272a;
      border-radius: 8px;
    }

    .timer {
      font-size: 32px;
      font-weight: 600;
      font-family: 'Consolas', 'SF Mono', monospace;
      color: #fafafa;
      letter-spacing: 1px;
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: #3f3f46;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      color: #a1a1aa;
    }

    .status-badge.recording {
      background: rgba(220, 38, 38, 0.2);
      color: #fca5a5;
    }

    .status-badge.paused {
      background: rgba(234, 179, 8, 0.2);
      color: #fde047;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    .status-badge.recording .status-dot {
      animation: pulse 1.2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* Sections */
    .section {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #71717a;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .section-header svg {
      width: 14px;
      height: 14px;
    }

    /* Source list */
    .source-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 140px;
      overflow-y: auto;
    }

    .source-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      background: #27272a;
      border: 1px solid transparent;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .source-item:hover {
      background: #3f3f46;
    }

    .source-item.selected {
      border-color: #dc2626;
      background: rgba(220, 38, 38, 0.1);
    }

    .source-thumb {
      width: 48px;
      height: 30px;
      border-radius: 4px;
      object-fit: cover;
      background: #3f3f46;
    }

    .source-name {
      font-size: 13px;
      color: #e4e4e7;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .source-check {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid #52525b;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }

    .source-item.selected .source-check {
      background: #dc2626;
      border-color: #dc2626;
    }

    .source-check svg {
      width: 10px;
      height: 10px;
      opacity: 0;
    }

    .source-item.selected .source-check svg {
      opacity: 1;
    }

    /* Audio options */
    .audio-row {
      display: flex;
      gap: 10px;
    }

    .audio-option {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: #27272a;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .audio-option:hover {
      background: #3f3f46;
    }

    .audio-option input {
      display: none;
    }

    .toggle {
      width: 36px;
      height: 20px;
      background: #3f3f46;
      border-radius: 10px;
      position: relative;
      transition: background 0.2s ease;
    }

    .toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      background: #71717a;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .audio-option input:checked + .toggle {
      background: #dc2626;
    }

    .audio-option input:checked + .toggle::after {
      left: 18px;
      background: #fff;
    }

    .audio-label {
      font-size: 13px;
      color: #a1a1aa;
    }

    .audio-option input:checked ~ .audio-label {
      color: #e4e4e7;
    }

    /* Controls */
    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: auto;
      padding-top: 20px;
      border-top: 1px solid #27272a;
    }

    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn svg {
      width: 16px;
      height: 16px;
    }

    .btn-primary {
      background: #dc2626;
      color: #fff;
    }

    .btn-primary:hover:not(:disabled) {
      background: #b91c1c;
    }

    .btn-row {
      display: flex;
      gap: 10px;
    }

    .btn-secondary {
      flex: 1;
      background: #27272a;
      color: #e4e4e7;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #3f3f46;
    }

    .btn-ghost {
      background: transparent;
      color: #71717a;
      border: 1px solid #3f3f46;
    }

    .btn-ghost:hover:not(:disabled) {
      background: #27272a;
      color: #a1a1aa;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      padding: 12px 16px;
      background: #27272a;
      border-radius: 6px;
      font-size: 13px;
      color: #e4e4e7;
      transform: translateY(80px);
      opacity: 0;
      transition: all 0.25s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast.success {
      border-left: 3px solid #22c55e;
    }

    .toast.error {
      border-left: 3px solid #ef4444;
    }

    .toast svg {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    .toast.success svg {
      color: #22c55e;
    }

    .toast.error svg {
      color: #ef4444;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 4px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #3f3f46;
      border-radius: 2px;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="logo">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="6"/></svg>
      </div>
      <h1>Screen Recorder</h1>
      <a class="github-link" id="githubLink" href="#" title="View on GitHub">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
        </svg>
      </a>
    </div>

    <div class="main">
      <div class="preview-container">
        <video class="preview-video" id="preview" autoplay muted></video>
        <div class="preview-overlay" id="previewOverlay">
          <span>No preview available</span>
        </div>
      </div>

      <div class="timer-row">
        <div class="timer" id="timer">00:00:00</div>
        <div class="status-badge" id="statusBadge">
          <span class="status-dot"></span>
          <span id="statusText">Ready</span>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="3" width="20" height="14" rx="2"/>
            <line x1="8" y1="21" x2="16" y2="21"/>
            <line x1="12" y1="17" x2="12" y2="21"/>
          </svg>
          <span>Select Source</span>
        </div>
        <div class="source-list" id="sourceList">
          <div class="source-item">
            <span class="source-name">Loading sources...</span>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
            <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
          </svg>
          <span>Audio</span>
        </div>
        <div class="audio-row">
          <label class="audio-option">
            <input type="checkbox" id="systemAudio" checked>
            <span class="toggle"></span>
            <span class="audio-label">System</span>
          </label>
          <label class="audio-option">
            <input type="checkbox" id="micAudio" checked>
            <span class="toggle"></span>
            <span class="audio-label">Microphone</span>
          </label>
        </div>
      </div>

      <div class="controls">
        <button class="btn btn-primary" id="startBtn" disabled>
          <svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="6"/></svg>
          Start Recording
        </button>
        <div class="btn-row">
          <button class="btn btn-secondary" id="pauseBtn" disabled>
            <svg viewBox="0 0 24 24" fill="currentColor">
              <rect x="6" y="4" width="4" height="16"/>
              <rect x="14" y="4" width="4" height="16"/>
            </svg>
            Pause
          </button>
          <button class="btn btn-secondary" id="stopBtn" disabled>
            <svg viewBox="0 0 24 24" fill="currentColor">
              <rect x="6" y="6" width="12" height="12" rx="2"/>
            </svg>
            Stop
          </button>
        </div>
        <button class="btn btn-ghost" id="resetBtn" disabled>
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
          </svg>
          Reset
        </button>
      </div>
    </div>
  </div>

  <div class="toast" id="notification">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
      <polyline points="22 4 12 14.01 9 11.01"/>
    </svg>
    <span id="notificationText"></span>
  </div>

  <script>
    const timerDisplay = document.getElementById('timer');
    const statusBadge = document.getElementById('statusBadge');
    const statusText = document.getElementById('statusText');
    const sourceList = document.getElementById('sourceList');
    const systemAudioCheckbox = document.getElementById('systemAudio');
    const micAudioCheckbox = document.getElementById('micAudio');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const stopBtn = document.getElementById('stopBtn');
    const resetBtn = document.getElementById('resetBtn');
    const preview = document.getElementById('preview');
    const previewOverlay = document.getElementById('previewOverlay');
    const notification = document.getElementById('notification');
    const notificationText = document.getElementById('notificationText');

    let mediaRecorder = null;
    let recordedChunks = [];
    let selectedSource = null;
    let timerInterval = null;
    let elapsedSeconds = 0;
    let isRecording = false;
    let isPaused = false;
    let mediaStream = null;

    function showNotification(message, type = 'info') {
      notificationText.textContent = message;
      notification.className = 'toast show ' + type;
      setTimeout(() => notification.classList.remove('show'), 3000);
    }

    function formatTime(seconds) {
      const hrs = Math.floor(seconds / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function updateTimer() {
      elapsedSeconds++;
      timerDisplay.textContent = formatTime(elapsedSeconds);
    }

    function updateStatus(status) {
      statusText.textContent = status;
      statusBadge.className = 'status-badge';
      if (status === 'Recording') statusBadge.classList.add('recording');
      else if (status === 'Paused') statusBadge.classList.add('paused');
    }

    async function loadSources() {
      try {
        const sources = await window.electronAPI.getSources();
        if (sources.length === 0) {
          showNotification('No screen sources found', 'error');
          return;
        }

        sourceList.innerHTML = '';
        sources.forEach(source => {
          const item = document.createElement('div');
          item.className = 'source-item';
          item.innerHTML = `
            <img class="source-thumb" src="${source.thumbnail}" alt="">
            <span class="source-name">${source.name}</span>
            <span class="source-check">
              <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
            </span>
          `;
          item.onclick = () => selectSource(source, item);
          sourceList.appendChild(item);
        });
      } catch (error) {
        console.error('Error loading sources:', error);
        showNotification('Error loading sources', 'error');
      }
    }

    function selectSource(source, item) {
      selectedSource = source;
      document.querySelectorAll('.source-item').forEach(el => el.classList.remove('selected'));
      item.classList.add('selected');
      startBtn.disabled = false;
      showNotification('Source selected', 'success');
    }

    async function startRecording() {
      if (!selectedSource) {
        showNotification('Select a source first', 'error');
        return;
      }

      try {
        const screenConstraints = {
          audio: systemAudioCheckbox.checked ? { mandatory: { chromeMediaSource: 'desktop' } } : false,
          video: { mandatory: { chromeMediaSource: 'desktop', chromeMediaSourceId: selectedSource.id } }
        };

        mediaStream = await navigator.mediaDevices.getUserMedia(screenConstraints);

        if (micAudioCheckbox.checked) {
          try {
            const micStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            const audioContext = new AudioContext();
            const destination = audioContext.createMediaStreamDestination();
            
            if (mediaStream.getAudioTracks().length > 0) {
              const screenAudioSource = audioContext.createMediaStreamSource(new MediaStream(mediaStream.getAudioTracks()));
              screenAudioSource.connect(destination);
            }
            
            const micSource = audioContext.createMediaStreamSource(micStream);
            micSource.connect(destination);
            
            const videoTrack = mediaStream.getVideoTracks()[0];
            const mixedAudioTrack = destination.stream.getAudioTracks()[0];
            mediaStream = new MediaStream([videoTrack, mixedAudioTrack]);
          } catch (micError) {
            console.warn('Could not access microphone:', micError);
          }
        }

        preview.srcObject = mediaStream;
        previewOverlay.classList.add('hidden');

        const options = { mimeType: 'video/webm; codecs=vp9' };
        if (!MediaRecorder.isTypeSupported(options.mimeType)) {
          options.mimeType = 'video/webm; codecs=vp8';
        }
        if (!MediaRecorder.isTypeSupported(options.mimeType)) {
          options.mimeType = 'video/webm';
        }

        mediaRecorder = new MediaRecorder(mediaStream, options);
        recordedChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) recordedChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
          const blob = new Blob(recordedChunks, { type: 'video/webm' });
          const buffer = await blob.arrayBuffer();
          const result = await window.electronAPI.saveVideo(buffer);
          if (result.success) showNotification('Recording saved', 'success');
          else if (!result.canceled) showNotification('Error saving', 'error');
        };

        mediaRecorder.start(1000);
        isRecording = true;
        isPaused = false;
        timerInterval = setInterval(updateTimer, 1000);

        updateStatus('Recording');
        startBtn.disabled = true;
        pauseBtn.disabled = false;
        stopBtn.disabled = false;
        resetBtn.disabled = true;
        
        showNotification('Recording started', 'success');
      } catch (error) {
        console.error('Error starting recording:', error);
        showNotification('Error: ' + error.message, 'error');
      }
    }

    function togglePause() {
      if (!mediaRecorder) return;

      if (isPaused) {
        mediaRecorder.resume();
        timerInterval = setInterval(updateTimer, 1000);
        isPaused = false;
        pauseBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="currentColor">
            <rect x="6" y="4" width="4" height="16"/>
            <rect x="14" y="4" width="4" height="16"/>
          </svg>
          Pause
        `;
        updateStatus('Recording');
      } else {
        mediaRecorder.pause();
        clearInterval(timerInterval);
        isPaused = true;
        pauseBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="currentColor">
            <polygon points="5,3 19,12 5,21"/>
          </svg>
          Resume
        `;
        updateStatus('Paused');
      }
    }

    function stopRecording() {
      if (!mediaRecorder) return;

      mediaRecorder.stop();
      if (mediaStream) mediaStream.getTracks().forEach(track => track.stop());
      clearInterval(timerInterval);
      
      isRecording = false;
      isPaused = false;

      updateStatus('Stopped');
      startBtn.disabled = false;
      pauseBtn.disabled = true;
      stopBtn.disabled = true;
      resetBtn.disabled = false;
      pauseBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="currentColor">
          <rect x="6" y="4" width="4" height="16"/>
          <rect x="14" y="4" width="4" height="16"/>
        </svg>
        Pause
      `;
      preview.srcObject = null;
      previewOverlay.classList.remove('hidden');
    }

    function resetRecorder() {
      elapsedSeconds = 0;
      timerDisplay.textContent = '00:00:00';
      recordedChunks = [];
      selectedSource = null;
      
      document.querySelectorAll('.source-item').forEach(el => el.classList.remove('selected'));
      
      updateStatus('Ready');
      startBtn.disabled = true;
      resetBtn.disabled = true;
      
      loadSources();
      showNotification('Reset complete', 'success');
    }

    startBtn.addEventListener('click', startRecording);
    pauseBtn.addEventListener('click', togglePause);
    stopBtn.addEventListener('click', stopRecording);
    resetBtn.addEventListener('click', resetRecorder);

    // GitHub link handler
    document.getElementById('githubLink').addEventListener('click', (e) => {
      e.preventDefault();
      if (window.electronAPI && window.electronAPI.openExternal) {
        window.electronAPI.openExternal('https://github.com/belinda-hagen/ScreenRecorder');
      } else {
        window.open('https://github.com/belinda-hagen/ScreenRecorder', '_blank');
      }
    });

    loadSources();
  </script>
</body>
</html>
