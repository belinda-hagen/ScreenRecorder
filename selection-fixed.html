<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Position Recording Area</title>
    <link rel="stylesheet" href="css/selection.css">
</head>

<body>
    <div class="overlay" id="overlay" tabindex="0"></div>

    <div class="instructions" id="instructions">
        <h2>Position Recording Area</h2>
        <p>Drag the blue rectangle to position it<br>Drag corners/edges to resize</p>
        <p class="tip">Press Enter to confirm • Escape to cancel</p>
        <p class="tip" id="scaleInfo" style="margin-top: 8px; color: #fbbf24;"></p>
    </div>

    <div class="selection-box" id="selectionBox">
        <div class="corner tl" data-resize="tl"></div>
        <div class="corner tr" data-resize="tr"></div>
        <div class="corner bl" data-resize="bl"></div>
        <div class="corner br" data-resize="br"></div>
        <div class="edge top" data-resize="t"></div>
        <div class="edge bottom" data-resize="b"></div>
        <div class="edge left" data-resize="l"></div>
        <div class="edge right" data-resize="r"></div>
        <div class="center-cross"></div>
        <div class="selection-info" id="selectionInfo">800 × 600</div>
    </div>

    <div class="size-input-panel">
        <h3>Recording Area Size</h3>
        <div class="size-inputs">
            <div class="input-group">
                <label>Width</label>
                <input type="number" id="widthInput" value="800" min="320" step="10">
            </div>
            <div class="input-group">
                <label>Height</label>
                <input type="number" id="heightInput" value="600" min="240" step="10">
            </div>
        </div>
        <div class="preset-buttons">
            <button class="preset-btn" data-width="1920" data-height="1080">1920×1080</button>
            <button class="preset-btn" data-width="1280" data-height="720">1280×720</button>
            <button class="preset-btn" data-width="800" data-height="600">800×600</button>
            <button class="preset-btn" data-width="640" data-height="480">640×480</button>
        </div>
    </div>

    <div class="confirm-buttons" id="confirmButtons">
        <button class="confirm-btn confirm" id="confirmBtn">Confirm Position</button>
        <button class="confirm-btn cancel" id="cancelBtn">Cancel</button>
    </div>

    <script>
        const overlay = document.getElementById('overlay');
        const instructions = document.getElementById('instructions');
        const selectionBox = document.getElementById('selectionBox');
        const selectionInfo = document.getElementById('selectionInfo');
        const confirmButtons = document.getElementById('confirmButtons');
        const confirmBtn = document.getElementById('confirmBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const scaleInfo = document.getElementById('scaleInfo');
        const widthInput = document.getElementById('widthInput');
        const heightInput = document.getElementById('heightInput');

        let isDragging = false;
        let isResizing = false;
        let resizeHandle = null;
        let dragStartX = 0;
        let dragStartY = 0;
        let boxStartX = 0;
        let boxStartY = 0;
        let boxStartWidth = 0;
        let boxStartHeight = 0;
        let selectionWidth = 800;
        let selectionHeight = 600;
        let selectionX = 0;
        let selectionY = 0;

        const MIN_WIDTH = 100;
        const MIN_HEIGHT = 100;

        // Detect and display scaling information
        const devicePixelRatio = window.devicePixelRatio || 1;
        if (devicePixelRatio !== 1) {
            scaleInfo.textContent = `Display scaling: ${Math.round(devicePixelRatio * 100)}% detected`;
        }

        // Center the selection box initially
        function centerSelectionBox() {
            selectionX = (window.innerWidth - selectionWidth) / 2;
            selectionY = (window.innerHeight - selectionHeight) / 2;
            updateSelectionBox(selectionX, selectionY, selectionWidth, selectionHeight);
        }

        function updateSelectionBox(x, y, width, height) {
            // Keep within bounds
            x = Math.max(0, Math.min(x, window.innerWidth - width));
            y = Math.max(0, Math.min(y, window.innerHeight - height));

            selectionX = x;
            selectionY = y;
            selectionWidth = width;
            selectionHeight = height;

            selectionBox.style.left = x + 'px';
            selectionBox.style.top = y + 'px';
            selectionBox.style.width = width + 'px';
            selectionBox.style.height = height + 'px';
            selectionInfo.textContent = `${Math.round(width)} × ${Math.round(height)}`;

            // Update input fields
            widthInput.value = Math.round(width);
            heightInput.value = Math.round(height);
        }

        function getSelection() {
            const rect = selectionBox.getBoundingClientRect();
            return {
                x: Math.round(rect.left),
                y: Math.round(rect.top),
                width: Math.round(rect.width),
                height: Math.round(rect.height)
            };
        }

        // Initialize
        centerSelectionBox();
        setTimeout(() => {
            instructions.classList.add('hidden');
            overlay.focus();
        }, 2000);

        // Resize functionality via corners and edges
        document.querySelectorAll('[data-resize]').forEach(handle => {
            handle.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return;
                e.preventDefault();
                e.stopPropagation();

                isResizing = true;
                resizeHandle = handle.dataset.resize;
                dragStartX = e.clientX;
                dragStartY = e.clientY;
                boxStartX = selectionX;
                boxStartY = selectionY;
                boxStartWidth = selectionWidth;
                boxStartHeight = selectionHeight;

                selectionBox.classList.add('dragging');
            });
        });

        // Dragging functionality (only on the box itself, not handles)
        selectionBox.addEventListener('mousedown', (e) => {
            if (e.button !== 0) return;
            // Don't drag if clicking on a resize handle
            if (e.target.dataset.resize) return;
            e.preventDefault();
            e.stopPropagation();

            isDragging = true;
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            boxStartX = selectionX;
            boxStartY = selectionY;

            selectionBox.classList.add('dragging');
        });

        window.addEventListener('mousemove', (e) => {
            if (isResizing) {
                e.preventDefault();
                const deltaX = e.clientX - dragStartX;
                const deltaY = e.clientY - dragStartY;

                let newX = boxStartX;
                let newY = boxStartY;
                let newWidth = boxStartWidth;
                let newHeight = boxStartHeight;

                // Handle resize based on which handle is being dragged
                switch (resizeHandle) {
                    case 'tl': // Top-left
                        newX = boxStartX + deltaX;
                        newY = boxStartY + deltaY;
                        newWidth = boxStartWidth - deltaX;
                        newHeight = boxStartHeight - deltaY;
                        break;
                    case 'tr': // Top-right
                        newY = boxStartY + deltaY;
                        newWidth = boxStartWidth + deltaX;
                        newHeight = boxStartHeight - deltaY;
                        break;
                    case 'bl': // Bottom-left
                        newX = boxStartX + deltaX;
                        newWidth = boxStartWidth - deltaX;
                        newHeight = boxStartHeight + deltaY;
                        break;
                    case 'br': // Bottom-right
                        newWidth = boxStartWidth + deltaX;
                        newHeight = boxStartHeight + deltaY;
                        break;
                    case 't': // Top edge
                        newY = boxStartY + deltaY;
                        newHeight = boxStartHeight - deltaY;
                        break;
                    case 'b': // Bottom edge
                        newHeight = boxStartHeight + deltaY;
                        break;
                    case 'l': // Left edge
                        newX = boxStartX + deltaX;
                        newWidth = boxStartWidth - deltaX;
                        break;
                    case 'r': // Right edge
                        newWidth = boxStartWidth + deltaX;
                        break;
                }

                // Enforce minimum size and prevent going off-screen
                if (newWidth < MIN_WIDTH) {
                    if (resizeHandle.includes('l')) {
                        newX = boxStartX + boxStartWidth - MIN_WIDTH;
                    }
                    newWidth = MIN_WIDTH;
                }
                if (newHeight < MIN_HEIGHT) {
                    if (resizeHandle.includes('t')) {
                        newY = boxStartY + boxStartHeight - MIN_HEIGHT;
                    }
                    newHeight = MIN_HEIGHT;
                }

                // Keep within screen bounds
                newX = Math.max(0, newX);
                newY = Math.max(0, newY);
                if (newX + newWidth > window.innerWidth) {
                    newWidth = window.innerWidth - newX;
                }
                if (newY + newHeight > window.innerHeight) {
                    newHeight = window.innerHeight - newY;
                }

                updateSelectionBox(newX, newY, newWidth, newHeight);
            } else if (isDragging) {
                e.preventDefault();
                const deltaX = e.clientX - dragStartX;
                const deltaY = e.clientY - dragStartY;
                const newX = boxStartX + deltaX;
                const newY = boxStartY + deltaY;

                updateSelectionBox(newX, newY, selectionWidth, selectionHeight);
            }
        });

        window.addEventListener('mouseup', (e) => {
            if (!isDragging && !isResizing) return;
            e.preventDefault();
            isDragging = false;
            isResizing = false;
            resizeHandle = null;
            selectionBox.classList.remove('dragging');
        });

        // Size input handlers
        widthInput.addEventListener('input', () => {
            const newWidth = Math.max(MIN_WIDTH, parseInt(widthInput.value) || 800);
            updateSelectionBox(selectionX, selectionY, newWidth, selectionHeight);
        });

        heightInput.addEventListener('input', () => {
            const newHeight = Math.max(MIN_HEIGHT, parseInt(heightInput.value) || 600);
            updateSelectionBox(selectionX, selectionY, selectionWidth, newHeight);
        });

        // Preset buttons
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                selectionWidth = parseInt(btn.dataset.width);
                selectionHeight = parseInt(btn.dataset.height);
                widthInput.value = selectionWidth;
                heightInput.value = selectionHeight;
                centerSelectionBox();
            });
        });

        // Confirm and cancel
        confirmBtn.addEventListener('click', (e) => {
            e.preventDefault();
            document.documentElement.classList.add('closing');
            document.body.classList.add('closing');
            setTimeout(() => {
                window.electronAPI.sendSelectionComplete(getSelection());
            }, 150);
        });

        cancelBtn.addEventListener('click', (e) => {
            e.preventDefault();
            document.documentElement.classList.add('closing');
            document.body.classList.add('closing');
            setTimeout(() => {
                window.electronAPI.sendSelectionCancelled();
            }, 150);
        });

        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' || e.key === 'Esc') {
                e.preventDefault();
                document.documentElement.classList.add('closing');
                document.body.classList.add('closing');
                setTimeout(() => {
                    window.electronAPI.sendSelectionCancelled();
                }, 150);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                document.documentElement.classList.add('closing');
                document.body.classList.add('closing');
                setTimeout(() => {
                    window.electronAPI.sendSelectionComplete(getSelection());
                }, 150);
            }
        });
    </script>
</body>

</html>
