<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Select Recording Area</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.3);
            cursor: crosshair;
            outline: none;
            opacity: 1;
            transition: opacity 0.2s ease;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        html.closing,
        body.closing {
            opacity: 0;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            outline: none;
        }

        .instructions {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 24px 32px;
            border-radius: 12px;
            font-family: 'Segoe UI', -apple-system, sans-serif;
            text-align: center;
            z-index: 1000;
            pointer-events: none;
            transition: opacity 0.3s ease;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .instructions h2 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #a78bfa;
        }

        .instructions p {
            font-size: 14px;
            color: #9ca3af;
        }

        .instructions .tip {
            margin-top: 12px;
            font-size: 12px;
            color: #667eea;
        }

        .instructions.hidden {
            opacity: 0;
        }

        .selection-box {
            position: fixed;
            border: 2px dashed #667eea;
            background: rgba(102, 126, 234, 0.1);
            pointer-events: none;
            display: none;
            z-index: 100;
        }

        .selection-box.active {
            display: block;
        }

        .selection-info {
            position: absolute;
            bottom: -28px;
            left: 0;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: 'Consolas', 'SF Mono', monospace;
            font-size: 12px;
            white-space: nowrap;
        }

        .corner {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #667eea;
            border-radius: 2px;
        }

        .corner.tl {
            top: -5px;
            left: -5px;
        }

        .corner.tr {
            top: -5px;
            right: -5px;
        }

        .corner.bl {
            bottom: -5px;
            left: -5px;
        }

        .corner.br {
            bottom: -5px;
            right: -5px;
        }

        .confirm-buttons {
            position: fixed;
            display: none;
            gap: 10px;
            z-index: 1001;
        }

        .confirm-buttons.visible {
            display: flex;
        }

        .confirm-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Segoe UI', -apple-system, sans-serif;
            transition: all 0.2s ease;
        }

        .confirm-btn.confirm {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        .confirm-btn.confirm:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .confirm-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .confirm-btn.cancel:hover {
            background: rgba(255, 255, 255, 0.2);
        }
    </style>
</head>

<body>
    <div class="overlay" id="overlay" tabindex="0"></div>

    <div class="instructions" id="instructions">
        <h2>Draw Selection Area</h2>
        <p>Click and drag to select the area to record.<br>Press <strong>Escape</strong> to cancel.</p>
        <p class="tip">Press Enter to confirm after drawing</p>
        <p class="tip" id="scaleInfo" style="margin-top: 8px; color: #fbbf24;"></p>
    </div>

    <div class="selection-box" id="selectionBox">
        <div class="corner tl"></div>
        <div class="corner tr"></div>
        <div class="corner bl"></div>
        <div class="corner br"></div>
        <div class="selection-info" id="selectionInfo">0 × 0</div>
    </div>

    <div class="confirm-buttons" id="confirmButtons">
        <button class="confirm-btn confirm" id="confirmBtn">Confirm Selection</button>
        <button class="confirm-btn cancel" id="cancelBtn">Cancel</button>
    </div>

    <script>
        const overlay = document.getElementById('overlay');
        const instructions = document.getElementById('instructions');
        const selectionBox = document.getElementById('selectionBox');
        const selectionInfo = document.getElementById('selectionInfo');
        const confirmButtons = document.getElementById('confirmButtons');
        const confirmBtn = document.getElementById('confirmBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const scaleInfo = document.getElementById('scaleInfo');

        let isDrawing = false;
        let startX = 0;
        let startY = 0;
        let currentSelection = null;

        // Detect and display scaling information
        const devicePixelRatio = window.devicePixelRatio || 1;
        if (devicePixelRatio !== 1) {
            scaleInfo.textContent = `Display scaling: ${Math.round(devicePixelRatio * 100)}% detected`;
        }

        // Ensure window has focus for keyboard events
        setTimeout(() => {
            overlay.focus();
        }, 100);

        function updateSelectionBox(x, y, width, height) {
            selectionBox.style.left = x + 'px';
            selectionBox.style.top = y + 'px';
            selectionBox.style.width = width + 'px';
            selectionBox.style.height = height + 'px';
            selectionInfo.textContent = `${Math.round(width)} × ${Math.round(height)}`;
        }

        function positionConfirmButtons() {
            const rect = selectionBox.getBoundingClientRect();
            const buttonHeight = 40;
            const margin = 10;

            let top = rect.bottom + margin;
            let left = rect.left + (rect.width / 2);

            // If buttons would go off screen bottom, position above selection
            if (top + buttonHeight > window.innerHeight) {
                top = rect.top - buttonHeight - margin;
            }

            // Keep buttons on screen horizontally
            const buttonsWidth = 220;
            left = Math.max(buttonsWidth / 2, Math.min(left, window.innerWidth - buttonsWidth / 2));

            confirmButtons.style.top = top + 'px';
            confirmButtons.style.left = left + 'px';
            confirmButtons.style.transform = 'translateX(-50%)';
        }

        overlay.addEventListener('mousedown', (e) => {
            if (e.button !== 0) return; // Only left click
            
            e.preventDefault();
            e.stopPropagation();

            isDrawing = true;
            startX = e.clientX;
            startY = e.clientY;

            instructions.classList.add('hidden');
            confirmButtons.classList.remove('visible');
            selectionBox.classList.add('active');

            updateSelectionBox(startX, startY, 0, 0);
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDrawing) return;

            e.preventDefault();

            const currentX = e.clientX;
            const currentY = e.clientY;

            const x = Math.min(startX, currentX);
            const y = Math.min(startY, currentY);
            const width = Math.abs(currentX - startX);
            const height = Math.abs(currentY - startY);

            updateSelectionBox(x, y, width, height);
        });

        window.addEventListener('mouseup', (e) => {
            if (!isDrawing) return;
            
            e.preventDefault();
            isDrawing = false;

            const currentX = e.clientX;
            const currentY = e.clientY;

            const x = Math.min(startX, currentX);
            const y = Math.min(startY, currentY);
            const width = Math.abs(currentX - startX);
            const height = Math.abs(currentY - startY);

            // Minimum selection size
            if (width < 50 || height < 50) {
                selectionBox.classList.remove('active');
                instructions.classList.remove('hidden');
                return;
            }

            // Store selection with local coordinates (will be converted by main process)
            currentSelection = {
                x: Math.round(x),
                y: Math.round(y),
                width: Math.round(width),
                height: Math.round(height)
            };

            positionConfirmButtons();
            confirmButtons.classList.add('visible');
        });

        confirmBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentSelection) {
                // Add closing animation
                document.documentElement.classList.add('closing');
                document.body.classList.add('closing');
                // Send selection after a short delay for animation
                setTimeout(() => {
                    window.electronAPI.sendSelectionComplete(currentSelection);
                }, 150);
            }
        });

        cancelBtn.addEventListener('click', (e) => {
            e.preventDefault();
            // Add closing animation
            document.documentElement.classList.add('closing');
            document.body.classList.add('closing');
            setTimeout(() => {
                window.electronAPI.sendSelectionCancelled();
            }, 150);
        });

        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' || e.key === 'Esc') {
                e.preventDefault();
                // Add closing animation
                document.documentElement.classList.add('closing');
                document.body.classList.add('closing');
                setTimeout(() => {
                    window.electronAPI.sendSelectionCancelled();
                }, 150);
            } else if (e.key === 'Enter' && currentSelection) {
                e.preventDefault();
                // Add closing animation
                document.documentElement.classList.add('closing');
                document.body.classList.add('closing');
                setTimeout(() => {
                    window.electronAPI.sendSelectionComplete(currentSelection);
                }, 150);
            }
        });
    </script>
</body>

</html>
